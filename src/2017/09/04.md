---
layout: template/hatena.jade
title: Docker for Mac で開発環境を構築する
---
<a id="top"></a>

* 開発環境にアクセスできなくなるリスクを無くしたい
* 開発者ごとの環境差位を無くしたい
* 特定の言語に縛られない開発をしたい

###### CONTENTS

1. [全体像](#development-flow)
1. [docker 入りのコンテナを起動](#run-docker-container)
1. [ruby スクリプトを実行](#run-ruby-script)
1. [web サーバーを起動](#run-web-server)
1. [まとめ](#postscript)
1. [参考資料](#reference)

###### SOURCE

* [getto-systems/labo-slim : GitHub](https://github.com/getto-systems/labo-slim)


<a id="development-flow"></a>
### 全体像

1. Docker for Mac から docker 入りコンテナを起動
1. tmux でプロジェクトルートディレクトリごとに作業
1. `docker run` で言語ごとのコンテナを起動

![全体像](https://i.gyazo.com/94501ba5ea45780639bddb968b5c3a2f.png)


[TOP](#top)
<a id="run-docker-container"></a>
### docker 入りのコンテナを起動

getto/labo-slim イメージを使用する。

* [getto-systems/labo-slim : GitHub](https://github.com/getto-systems/labo-slim)

docker に加えて zsh と neovim が開発用として入っている。

まず、ローカルの適当なディレクトリに apps と dotfiles ディレクトリを作成する。

dotfiles ディレクトリには自分の dotfiles を展開しておく。

用意ができたら、このイメージを使用して環境に入る。

```bash
user=${YOUR_USER_NAME}
root=${YOUR_WORKING_ROOT_DIR}
home=/home/$user
timezone=Asia/Tokyo
image=getto/labo-slim

docker run -it --rm \
  --detach-keys ctrl-@,ctrl-@ \
  -e DOCKER_WRAPPER_VOLUMES=$root/apps:/apps \
  -e LABO_USER=$user \
  -e LABO_TIMEZONE=$timezone \
  -v $root/apps:/apps \
  -v $root/dotfiles:$home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -w $home \
  $image
```

user は好みのユーザー名を使用できる。

```bash
$ docker ps
CONTAINER ID ... （実際の出力）
```

このコンテナの中で docker コマンドを使用可能になっている。

もし `permission denied` で実行できない場合は以下のコマンドを実行しておく。

```bash
$ sudo chown $LABO_USER:$LABO_USER /var/run/docker.sock
```

sudo もパスワードなしで使用可能なのでなんでもできる。


[TOP](#top)
<a id="run-ruby-script"></a>
### ruby スクリプトを実行

```bash
. docker-wrapper.sh
docker run \
  --rm \
  -u 1000:1000 \
  -w $(pwd) \
  $(docker_wrapper_home) \
  $(docker_wrapper_tty) \
  $(docker_wrapper_volumes) \
  "${docker_wrapper_envs[@]}" \
  $(docker_wrapper_image ruby) \
  ruby "${docker_wrapper_args[@]}" \
;
```


[TOP](#top)
<a id="run-web-server"></a>
### web サーバーを起動

```bash
. docker-wrapper.sh
docker_wrapper_server livereload
if [ "$docker_wrapper_server_cmd" == start ]; then
  docker run \
    -d \
    -u 1000:1000 \
    -w $APP_ROOT \
    $(docker_wrapper_server_name) \
    $(docker_wrapper_home) \
    $(docker_wrapper_volumes) \
    "${docker_wrapper_envs[@]}" \
    $(docker_wrapper_image node) \
    npm run livereload \
  ;
fi
```


[TOP](#top)
<a id="postscript"></a>
### まとめ

* tmux-wrapper : プロジェクトごとに tmux するという作戦について
* docker-wrapper : コマンドの wrapper を用意しておく作戦について
* direnv : プロジェクトごとの環境変数の管理について
* zplug : スクリプトの管理について

[TOP](#top)
<a id="reference"></a>
### 参考資料

* [docker attach : Docker Docs](https://docs.docker.com/engine/reference/commandline/attach/)


[TOP](#top)
